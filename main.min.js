const debug=!0;var requestInfo={status:!1,reDraw:!1,time:(new Date).getTime(),text:"debug",meta:"none"};const callServer=google.script.run.withSuccessHandler(defaultSuccessHandler).withFailureHandler(defaultFailureHandler),classes={},queueExec=[];function defaultSuccessHandler(t){requestDone(t)}function defaultFailureHandler(t){alert("<hr>defaultFailureHandler return:<br>"+t),requestDone(t)}function requestLog(t,e=!0,s=!1){return!!requestInfo.status||(requestInfo.status=!0,requestInfo.time=(new Date).getTime(),requestInfo.text=t,requestInfo.reDraw=s,console.log("=> Running request "+requestInfo.text),!1)}function requestDone(t){$(".loader").fadeOut("slow"),requestInfo.status=!1,requestInfo.meta="none",console.log("=> Request '"+requestInfo.text+"' took "+((new Date).getTime()-requestInfo.time)/1e3+" seconds"),console.log(t),console.log("=========================================="),queueExec.length>0&&startQueueForAgentInfo()}function startQueueForAgentInfo(){let t=queueExec.shift();console.log(arguments.callee.name+" start exec with "+(adminList.includes(userEmail)?"all":userEmail)),t()}function requestInProgress(){return"=> Currently executing: "+requestInfo.text}function getNameFromEmail(t){var e=t.split("@")[0].split(".");return 1==e.length?e[0].charAt(0).toUpperCase()+e[0].slice(1):e[0].charAt(0).toUpperCase()+e[0].slice(1)+" "+e[1].charAt(0).toUpperCase()+e[1].slice(1)}function hashCode(t){for(var e=0,s=0;s<t.length;s++)e=t.charCodeAt(s)+((e<<5)-e);return e}function hexToRgb(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function intToHEX(t){var e=(16777215&t).toString(16).toUpperCase();return"00000".substring(0,6-e.length)+e}function getColorHEX(t){return"#"+intToHEX(hashCode(t))}function getColorRGB(t){return hexToRgb(getColorHEX(t))}function getRGBAString(t){const e=hexToRgb(getColorHEX(t));return`rgba(${e.r}, ${e.g}, ${e.b}, 0.6)`}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.getName=function(){let t="";return t=-1!=this.indexOf("-Agent-")?this.split("-")[2].split("@")[0].split(".")[0].charAt(0).toUpperCase()+this.split("-")[2].split("@")[0].split(".")[0].slice(1)+" "+this.split("-")[2].split("@")[0].split(".")[1].charAt(0).toUpperCase()+this.split("-")[2].split("@")[0].split(".")[1].slice(1):-1!=this.indexOf("@")?this.split("@")[0].split(".")[0].charAt(0).toUpperCase()+this.split("@")[0].split(".")[0].slice(1)+" "+this.split("@")[0].split(".")[1].charAt(0).toUpperCase()+this.split("@")[0].split(".")[1].slice(1):this.split(".")[0].charAt(0).toUpperCase()+this.split(".")[0].slice(1)+" "+this.split(".")[1].charAt(0).toUpperCase()+this.split(".")[1].slice(1),t};class localStorageSingletone{constructor(){this.storages=new Map}add(t,e){this.storages.set(t,e)}get(t){return this.storages.get(t)}}const localStorages=new localStorageSingletone;class CRMAppStats{constructor(t){this.class=CRMAppStats,this.count=0,t?(this.date=t.date,this.time=t.time,this.total=t.total,this.typeDirect=t.typeDirect,this.typePS=t.typePS,this.typeOB=t.typeOB,this.typeTS=t.typeTS,this.suitePro=t.suitePro,this.suiteEnt=t.suiteEnt,this.suiteBsc=t.suiteBsc,this.imports=t.imports,this.outCompleted=t.outCompleted,this.outRescheduled=t.outRescheduled,this.outDeclined=t.outDeclined,this.outNoShow=t.outNoShow,this.rules=t.rules,this.calendar=t.calendar,this.stopics=t.stopics,this.analytics=t.analytics,this.surveys=t.surveys,this.chat=t.chat,this.other=t.other,this.successComplete=t.successComplete):(this.date="",this.time=0,this.total=0,this.typeDirect=0,this.typePS=0,this.typeOB=0,this.typeTS=0,this.suitePro=0,this.suiteEnt=0,this.suiteBsc=0,this.imports=0,this.outCompleted=0,this.outRescheduled=0,this.outDeclined=0,this.outNoShow=0,this.rules=0,this.calendar=0,this.stopics=0,this.analytics=0,this.surveys=0,this.chat=0,this.other=0,this.successComplete=0)}add(t){this.count++,this.date||(this.date=t.date),this.time||(this.time=t.time),this.total+=t.total,this.typeDirect+=t.typeDirect,this.typePS+=t.typePS,this.typeOB+=t.typeOB,this.typeTS+=t.typeTS,this.suitePro+=t.suitePro,this.suiteEnt+=t.suiteEnt,this.suiteBsc+=t.suiteBsc,this.imports+=t.imports,this.outCompleted+=t.outCompleted,this.outRescheduled+=t.outRescheduled,this.outDeclined+=t.outDeclined,this.outNoShow+=t.outNoShow,this.rules+=t.rules,this.calendar+=t.calendar,this.stopics+=t.stopics,this.analytics+=t.analytics,this.surveys+=t.surveys,this.chat+=t.chat,this.other+=t.other,this.successComplete+=t.successComplete}}classes.CRMAppStats=CRMAppStats,localStorages.add("CRMAppStats",new Map);class DatePickrControl{constructor(){this.initiated=!1,this.pickrFrom,this.pickrTo}getToTime(){return this.pickrTo.selectedDates[0].setHours(23,59,59,59)}getFromTime(){return this.pickrFrom.selectedDates[0].setHours(0,0,0,1)}getTo(){return this.pickrTo.selectedDates[0]}getFrom(){return this.pickrFrom.selectedDates[0]}init(){if(this.initiated)return console.error("DatePickrControl initiation more than 1 time");this.initiated=!0,this.pickrFrom=this.createFromPickr(),this.pickrTo=this.createToPickr()}createFromPickr(){return flatpickr("#flatpickr-obt-fromdate",{maxDate:"today",altInput:!0,altFormat:"F j, Y",defaultDate:[new Date((new Date).setDate((new Date).getDate()-7))],dateFormat:"Y-m-d",locale:{firstDayOfWeek:1},onChange:function(t,e,s){1==t.length&&updateToPickr(t[0])},getWeek:function(t){}})}createToPickr(){return flatpickr("#flatpickr-obt-todate",{maxDate:"today",altInput:!0,altFormat:"F j, Y",defaultDate:["today"],dateFormat:"Y-m-d",locale:{firstDayOfWeek:1},onChange:function(t,e,s){1==t.length&&updateFromPickr(t[0])},getWeek:function(t){}})}}const dateSelector=new DatePickrControl;function updateFromPickr(t){dateSelector.pickrFrom.config.disable=[function(e){return moment(e)>moment(t)}],dateSelector.pickrFrom.redraw(),runUpdate()}function updateToPickr(t){dateSelector.pickrTo.config.disable=[function(e){return moment(e)<moment(t)}],dateSelector.pickrTo.redraw(),runUpdate()}dateSelector.init();class FTAppStats{constructor(t){this.class=FTAppStats,this.count=0,t?(this.date=t.date,this.time=t.time,this.total=t.total,this.made=t.made,this.noshow=t.noshow,this.declined=t.declined,this.reschedule=t.reschedule):(this.date="",this.time=0,this.total=0,this.made=0,this.noshow=0,this.declined=0,this.reschedule=0)}add(t){this.date||(this.date=t.date),this.time||(this.time=t.time),this.count++,this.total+=t.total,this.made+=t.made,this.noshow+=t.noshow,this.declined+=t.declined,this.reschedule+=t.reschedule}}classes.FTAppStats=FTAppStats,localStorages.add("FTAppStats",new Map);class FTCompletionStats{constructor(t){this.class=FTCompletionStats,this.count=0,t?(this.date=t.date,this.time=t.time,this.total=t.total,this.confirmed=t.confirmed,this.passive=t.passive,this.declined=t.declined,this.cancel=t.cancel):(this.date="",this.time=0,this.total=0,this.confirmed=0,this.passive=0,this.declined=0,this.cancel=0)}add(t){this.date||(this.date=t.date),this.time||(this.time=t.time),this.count++,this.total+=t.total,this.confirmed+=t.confirmed,this.passive+=t.passive,this.declined+=t.declined,this.cancel+=t.cancel}}classes.FTCompletionStats=FTCompletionStats,localStorages.add("FTCompletionStats",new Map);class OBContactsStats{constructor(t){this.class=OBContactsStats,this.count=0,t?(this.date=t.date,this.time=t.time,this.name=t.name,this.team=t.team,this.zero3=t.zero3,this.four=t.four,this.fiveplus=t.fiveplus,this.zero3perc=t.zero3perc,this.fourperc=t.fourperc,this.fiveplus=t.fiveplus,this.total=t.total,this.totalperc=t.totalperc):(this.date=0,this.time=0,this.name=0,this.team=0,this.zero3=0,this.four=0,this.fiveplus=0,this.zero3perc=0,this.fourperc=0,this.fiveplus=0,this.total=0,this.totalperc=0)}add(t){this.date||(this.date=t.date),this.time||(this.time=t.time),this.name||(this.name=t.name),this.team||(this.team=t.team),this.zero3+=t.zero3,this.four+=t.four,this.fiveplus+=t.fiveplus,this.zero3perc+=t.zero3perc,this.fourperc+=t.fourperc,this.fiveplus+=t.fiveplus,this.total+=t.total,this.totalperc+=t.totalperc}}classes.OBContactsStats=OBContactsStats,localStorages.add("OBContactsStats",new Map);class OBPortfolioStats{constructor(t){this.class=OBPortfolioStats,this.count=0,t?(this.date="",this.time=0,this.pm=t.pm,this.queue=t.queue,this.beg=t.beg,this.endportfolio=t.endportfolio,this.portfolio=t.portfolio,this.lcyesterday=t.lcyesterday,this.notcontacted48h=t.notcontacted48h,this.notcontacted72h=t.notcontacted72h,this.t1createdyesterday=t.t1createdyesterday,this.t1createdalltime=t.t1createdalltime,this.inboundcalls=t.inboundcalls,this.outboundcalls=t.outboundcalls,this.internalcalls=t.internalcalls,this.totalcalls=t.totalcalls,this.tickets=t.tickets,this.totaltolktime=t.totaltolktime,this.callsporfolioratio=t.callsporfolioratio):(this.date="",this.time=0,this.pm="",this.queue=0,this.beg=0,this.endportfolio=0,this.portfolio=0,this.lcyesterday=0,this.notcontacted48h=0,this.notcontacted72h=0,this.t1createdyesterday=0,this.t1createdalltime=0,this.inboundcalls=0,this.outboundcalls=0,this.internalcalls=0,this.totalcalls=0,this.tickets=0,this.totaltolktime=0,this.callsporfolioratio=0)}add(t){this.total++,this.date||(this.date=t.date),this.time||(this.time=t.time),this.pm||(this.pm=t.pm),this.queue||(this.queue=t.queue),this.beg+=t.beg,this.endportfolio+=t.endportfolio,this.portfolio+=t.portfolio,this.lcyesterday+=t.lcyesterday,this.notcontacted48h+=t.notcontacted48h,this.notcontacted72h+=t.notcontacted72h,this.t1createdyesterday+=t.t1createdyesterday,this.t1createdalltime+=t.t1createdalltime,this.inboundcalls+=t.inboundcalls,this.outboundcalls+=t.outboundcalls,this.internalcalls+=t.internalcalls,this.totalcalls+=t.totalcalls,this.tickets+=t.tickets,this.totaltolktime+=getseconds(t.totaltolktime),this.callsporfolioratio+=t.callsporfolioratio}}classes.OBPortfolioStats=OBPortfolioStats,localStorages.add("OBPortfolioStats",new Map);class OBTAppStats{constructor(t){this.class=OBTAppStats,t?(this.date=t.date,this.time=t.time,this.total=t.total,this.typeImpl=t.typeImpl,this.typeNet=t.typeNet,this.typeTS=t.typeTS,this.typeTR=t.typeTR,this.typeOCS=t.typeOCS,this.outMade=t.outMade):(this.date="",this.time=0,this.total=0,this.typeImpl=0,this.typeNet=0,this.typeTS=0,this.typeTR=0,this.typeOCS=0,this.outMade=0)}add(t){this.date||(this.date=t.date),this.time||(this.time=t.time),this.count++,this.total+=t.total,this.typeImpl+=t.typeImpl,this.typeNet+=t.typeNet,this.typeTS+=t.typeTS,this.typeTR+=t.typeTR,this.typeOCS+=t.typeOCS,this.outMade+=t.outMade}}classes.OBTAppStats=OBTAppStats,localStorages.add("OBTAppStats",new Map);class OBTCasesStats{constructor(t){this.class=OBTCasesStats,t?(this.date=t.date,this.time=t.time,this.total=t.total,this.builds=t.builds,this.updates=t.updates,this.assignments=t.assignments,this.mid=t.mid,this.enterprise=t.enterprise,this.fasttrack=t.fasttrack,this.migration=t.migration,this.insidesales=t.insidesales,this.channel=t.channel,this.franchise=t.franchise,this.otherSale=t.otherSale,this.usersCreated=t.usersCreated,this.usersUpdated=t.usersUpdated,this.featuresCreated=t.featuresCreated,this.featuresUpdated=t.featuresUpdated,this.servicesCreated=t.servicesCreated,this.servicesUpdated=t.servicesUpdated,this.other=t.other):(this.date="",this.time=0,this.total=0,this.builds=0,this.updates=0,this.assignments=0,this.mid=0,this.enterprise=0,this.fasttrack=0,this.migration=0,this.insidesales=0,this.channel=0,this.franchise=0,this.otherSale=0,this.usersCreated=0,this.usersUpdated=0,this.featuresCreated=0,this.featuresUpdated=0,this.servicesCreated=0,this.servicesUpdated=0,this.other=0)}add(t){this.date||(this.date=t.date),this.time||(this.time=t.time),this.total+=t.total,this.builds+=t.builds,this.updates+=t.updates,this.assignments+=t.assignments,this.mid+=t.mid,this.enterprise+=t.enterprise,this.fasttrack+=t.fasttrack,this.migration+=t.migration,this.insidesales+=t.insidesales,this.channel+=t.channel,this.franchise+=t.franchise,this.otherSale+=t.otherSale,this.usersCreated+=t.usersCreated,this.usersUpdated+=t.usersUpdated,this.featuresCreated+=t.featuresCreated,this.featuresUpdated+=t.featuresUpdated,this.servicesCreated+=t.servicesCreated,this.servicesUpdated+=t.servicesUpdated,this.other+=t.other}}classes.OBTCasesStats=OBTCasesStats,localStorages.add("OBTCasesStats",new Map),localStorages.add("teamRoaster",new Map),$(window).on("load",(function(){if(console.log("=> Page took to load "+((new Date).getTime()-timePageLoading)/1e3+" seconds"),requestLog(arguments.callee.name))return showAlert(requestInProgress());callServer.withSuccessHandler(onDataLoaded).getStorage()}));const onLoadQueue=[];function onDataLoaded(t){console.groupCollapsed("Saving Stats Log");for(const e of t[1])saveStats(e);console.groupEnd(),onLoadQueue.forEach(e=>{e(t)}),$(".obt-dashboard-page-container:not(:first-of-type)").hide(),runUpdate(),requestDone(t)}const updateQueue=[],countQueue=[];function runUpdate(){countQueue.forEach(t=>{t()}),updateQueue.forEach(t=>{t()})}$(".obt-dashboard-left-menu-item").on("click",(function(t){$(".obt-dashboard-page-container").hide(),$(".obt-dashboard-left-menu-item").removeClass("active"),$(this).addClass("active");const e=$(this).attr("page");$("#obt-dashboard-page-"+e).show()}));class leftMenuSingletone{constructor(){}updateName(t){$("#obt-dashboard-left-menu-username").text(getNameFromEmail(t[0])),$("#obt-dashboard-left-menu-avatar").attr("src",`https://icotar.com/avatar/${t[0].split("@")[0]}.png?s=500`)}}const leftMenu=new leftMenuSingletone;function saveStats(t){const e=t[0].split("-"),s=localStorages.get(e[0]);try{"Array"==t[1]?s.set(t[0],JSON.parse(t[2])):s.set(t[0],new classes[t[1]](JSON.parse(t[2])))}catch(e){console.log(`storage.set(${t[0]}, new classes[${t[1]}](JSON.parse()));`),console.log("error",e)}}onLoadQueue.push(leftMenu.updateName);const statsTypes=["OBTCasesStats","OBTAppStats","FTCompletionStats","CRMAppStats"];function countWorkDays(t,e){const s=new Date(t),a=new Date(e);s.setHours(0,0,0,1),a.setHours(23,59,59,999);let i=a-s,o=Math.ceil(i/864e5);o-=2*Math.floor(o/7);let r=s.getDay(),n=a.getDay();r-n>1&&(o-=2),0==r&&6!=n&&o--,6==n&&0!=r&&o--}function countPeriods(){const t=dateSelector.getFromTime(),e=dateSelector.getToTime();console.log(t);const s={text:"",from:t,to:e},a=countWorkDays(t,e);console.log(`Selected ${a} work days.`);const i={text:"",from:t-(e-t),to:t-1e3};console.groupCollapsed("==********[ countPeriods ]*********=="),console.log("crntPeriod",s),console.log("prvsPeriod",i),console.groupCollapsed("Included list"),statsTypes.forEach(t=>{const e=localStorages.get(t);console.log("==*********************************=="),console.log("-------------------------------------"),console.log("Working with "+t),console.log(e),console.log("-------------------------------------"),s.text=t+"-CurrentPeriod",i.text=t+"-PreviousePeriod",e.set(s.text,""),e.set(i.text,""),e.forEach((t,a)=>{if(-1!==a.indexOf("-Date-"))if(t.time>=s.from&&t.time<=s.to){console.log("included in current period",t);let a=e.get(s.text);a||(a=new t.class),a.add(t),e.set(s.text,a)}else if(t.time>=i.from&&t.time<=i.to){console.log("included in previouse period",t);let s=e.get(i.text);s||(s=new t.class),s.add(t),e.set(i.text,s)}})}),console.groupEnd(),console.log("==*********************************=="),console.groupEnd()}countQueue.push(countPeriods);class dashFTchartSingletone{constructor(){this.chart=echarts.init(document.getElementById("dashboard-chart-ft-completions"))}update(){const t=localStorages.get("FTCompletionStats"),e=[],s=[],a=[],i=[],o=[],r=dateSelector.getFromTime(),n=dateSelector.getToTime();t.forEach((t,l)=>{-1!==l.indexOf("-Date-")&&t.time>=r&&t.time<=n&&(e.push(makeMMDDYYYY(t.time)),s.push(t.confirmed),a.push(t.declined),i.push(t.passive),o.push(t.cancel))}),dashFTComplChart.init({legend:["Confirmed","Declined","Passive","Cancel"],labels:e,colors:[],series:[{name:"Confirmed",type:"line",smooth:!0,itemStyle:{normal:{areaStyle:{type:"default"}}},data:s},{name:"Declined",type:"line",smooth:!0,itemStyle:{normal:{areaStyle:{type:"default"}}},data:a},{name:"Passive",type:"line",smooth:!0,itemStyle:{normal:{areaStyle:{type:"default"}}},data:i},{name:"Cancel",type:"line",smooth:!0,itemStyle:{normal:{areaStyle:{type:"default"}}},data:o}]})}init(t){t||(t={legend:["Confirmed","Declined","Passive","Cancel"],labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],series:[],colors:[getRGBAString("Confirmed"),getRGBAString("Declined"),getRGBAString("Passive"),getRGBAString("Cancel")]}),this.chart.setOption({tooltip:{trigger:"axis"},legend:{textStyle:{color:"#9aa0ac"},data:t.legend},toolbox:{show:!1},calculable:!1,xAxis:[{type:"category",data:t.labels,axisLabel:{fontSize:10,color:"#9aa0ac"}}],yAxis:[{type:"value",axisLabel:{fontSize:10,color:"#9aa0ac"}}],series:t.series,color:t.colors})}}const dashFTComplChart=new dashFTchartSingletone;dashFTComplChart.init(),updateQueue.push(dashFTComplChart.update);class dashOBTCasesChartSingletone{constructor(){this.chart=echarts.init(document.getElementById("dashboard-chart-obt-cases"))}init(t){t||(t={category:["2000","2001","2002","2003","2004","2005"],builds:[22,54,37,23,25.6,76],assignments:[35,45,47,10,35,70],updates:[11,25,45,15,25,40]}),this.chart.setOption({responsive:!0,maintainAspectRatio:!1,tooltip:{trigger:"axis"},legend:{textStyle:{color:"#9aa0ac"},data:["Builds","Assignments","Updates"]},toolbox:{show:1},calculable:1,xAxis:[{type:"category",data:t.category,axisLabel:{fontSize:10,color:"#9aa0ac"}}],yAxis:[{type:"value",axisLabel:{fontSize:10,color:"#9aa0ac"}}],series:[{name:"Builds",type:"bar",data:t.builds,markPoint:{data:[{type:"max",name:"???"},{type:"min",name:"???"}]},markLine:{data:[{type:"average",name:"???"}]}},{name:"Assignments",type:"bar",data:t.assignments,markPoint:{data:[{type:"max",name:"???"},{type:"min",name:"???"}]},markLine:{data:[{type:"average",name:"???"}]}},{name:"Updates",type:"bar",data:t.updates,markPoint:{data:[{type:"max",name:"???"},{type:"min",name:"???"}]},markLine:{data:[{type:"average",name:"???"}]}}],color:["#65a986","#4f8bb7","#d68e41"]})}getChartMode(t,e){let s=(e-t)/24/60/60/1e3;return s<60?"Date":s<700?"Month":"Year"}update(){const t=localStorages.get("OBTCasesStats"),e=[],s=[],a=[],i=[],o=dateSelector.getFromTime(),r=dateSelector.getToTime();let n=dashOBTCasesChart.getChartMode(o,r);t.forEach((t,l)=>{-1!==l.indexOf(`-${n}-`)&&t.time>=o&&t.time<=r&&("Date"==n?e.push(makeMMDDYYYY(t.time)):"Month"==n?e.push(makeMMMYYYY(t.time)):e.push(makeYYYY(t.time)),s.push(t.builds),a.push(t.assignments),i.push(t.updates))}),dashOBTCasesChart.init({category:e,builds:s,assignments:a,updates:i})}}const dashOBTCasesChart=new dashOBTCasesChartSingletone;dashOBTCasesChart.init(),updateQueue.push(dashOBTCasesChart.update);const DashboardCards=["OBTCasesStats","OBTAppStats","FTCompletionStats","CRMAppStats"];function getDashboardCardsStats(){const t={};return DashboardCards.forEach(e=>{const s=localStorages.get(e),a=s.get(e+"-PreviousePeriod"),i=s.get(e+"-CurrentPeriod"),o=0==a.total?101:Math.round(i.total/a.total*1e4)/100,r={number:i.total?i.total:0,progress:(o||0)+"%",arrow:a.total<=i.total,percents:(o?Math.round(100*Math.abs(o-100))/100:0)+"%",last:a.total?a.total:0};t[e]=r}),console.log("getDashboardCardsStats",t),t}function updateAllDashboardCards(){const t=getDashboardCardsStats();for(const e of DashboardCards)updateDashboardCard(e,t[e])}function updateDashboardCard(t,e){const s=document.getElementById(`dashboard-top-card-${t}-this-month`),a=document.getElementById(`dashboard-top-card-${t}-progressbar`),i=document.getElementById(`dashboard-top-card-${t}-compare-to-last-month-percents`);s.innerHTML=e.number+` (prev. ${e.last})`,a.setAttribute("style",`width: ${e.progress};`),i.innerHTML=`<i class="fa fa-arrow-${e.arrow?"up":"down"}"></i> ${e.percents}`}updateQueue.push(updateAllDashboardCards);class obtChartCasesByTeamSingletone{constructor(){this.chart=echarts.init(document.getElementById("obt-chart-cases-by-team"))}}